seeSure! Here’s a breakdown for your script:

**Goal:**
The goal of the script is to update all existing records in the production DynamoDB table by adding an expiration field with a calculated expiration date, ensuring that only records that currently lack the expiration field are updated.

**Acceptance Criteria:**

1. The script must scan all existing records in the DynamoDB table.
2. Only records that do not have the expiration field should be updated.
3. The script should add the expiration field with a value calculated based on a defined logic (for example, a certain number of days from the current date).
4. New records or records that already have the expiration field should remain unchanged.

**Given-When-Then Scenario:**

* **Given** there are existing records in the DynamoDB table without an expiration field,
* **When** the script is executed,
* **Then** those records should have the expiration field added with the correct expiration date, and records that already had the expiration field should remain unchanged.

**Steps to Create the Script:**

1. **Set up your environment:** Make sure you have the AWS SDK installed for the language of your choice (e.g., Boto3 for Python).
2. **Scan the table:** Use the `Scan` operation to retrieve all records from the table.
3. **Check for the expiration field:** For each record, check if the expiration field is missing.
4. **Calculate the expiration date:** Define the logic for calculating the expiration date (e.g., current time plus a certain number of days).
5. **Update the record:** Use the `UpdateItem` operation to add the expiration field to records that need it.
6. **Run and verify:** Execute the script in a test environment first to ensure it works as expected before running it in production.
   \[media pointer="sediment://file\_00000000011c622fbe47b55d0c7dede0"]




1. Script
bash
Copiar
Editar
#!/bin/bash

TABLE_NAME="dyno-db"
LOG_FILE="expiration_update_log.csv"
MAX_JOBS=20
EXPIRATION_DAYS=60

echo "ID,ACCOUNTNUMBER,Status" > "$LOG_FILE"

get_expiration_epoch() {
  date -d "+${EXPIRATION_DAYS} days" +%s
}

wait_for_jobs() {
  while (( $(jobs -rp | wc -l) >= MAX_JOBS )); do
    sleep 0.2
  done
}

process_page() {
  local page_file="$1"
  cat "$page_file" | jq -c '.Items[]' | while read item; do
    ID=$(echo "$item" | jq -r '.ID.S')
    ACCOUNTNUMBER=$(echo "$item" | jq -r '.ACCOUNTNUMBER.S')
    HAS_EXPIRATION=$(echo "$item" | jq 'has("expiration")')
    if [[ "$HAS_EXPIRATION" == "false" && -n "$ID" && -n "$ACCOUNTNUMBER" ]]; then
      wait_for_jobs
      {
        EXPIRATION=$(get_expiration_epoch)
        aws dynamodb update-item --table-name "$TABLE_NAME" \
          --key '{"ID": {"S": "'"$ID"'"}, "ACCOUNTNUMBER": {"S": "'"$ACCOUNTNUMBER"'"}}' \
          --update-expression "SET expiration = :exp" \
          --expression-attribute-values '{":exp": {"N": "'"$EXPIRATION"'"}}' \
          --return-values NONE
        echo "$ID,$ACCOUNTNUMBER,Updated" >> "$LOG_FILE"
      } &
    else
      echo "$ID,$ACCOUNTNUMBER,Skipped: Already has expiration or missing keys" >> "$LOG_FILE"
    fi
  done
}

echo "Scanning DynamoDB table $TABLE_NAME..."

LAST_EVALUATED_KEY=""
PAGE=1

while :; do
  SCAN_FILE="scan_page_$PAGE.json"
  if [[ -z "$LAST_EVALUATED_KEY" ]]; then
    aws dynamodb scan --table-name "$TABLE_NAME" --output json > "$SCAN_FILE"
  else
    aws dynamodb scan --table-name "$TABLE_NAME" --output json \
      --starting-token "$LAST_EVALUATED_KEY" > "$SCAN_FILE"
  fi

  process_page "$SCAN_FILE"

  LAST_EVALUATED_KEY=$(jq -r '.NextToken // empty' "$SCAN_FILE")
  if [[ -z "$LAST_EVALUATED_KEY" ]]; then
    break
  fi
  PAGE=$((PAGE + 1))
done

wait
sleep 5

UPDATED_COUNT=$(grep -c ',Updated' "$LOG_FILE")
echo "Update complete. $UPDATED_COUNT records updated. See $LOG_FILE for details."
2. How it works (in detail)
Scans the entire DynamoDB table in pages (to handle very large datasets).

For each record:

Extracts ID and ACCOUNTNUMBER keys.

Checks if the record does not have the expiration field.

If expiration is missing:

Calculates an expiration value (current epoch + 60 days).

Updates the record in DynamoDB to add the expiration attribute.

Logs the update in expiration_update_log.csv.

If expiration exists or a key is missing, logs as "Skipped."

Runs up to 20 updates in parallel to speed up the process.

At the end, prints the number of updated records and tells you where to find the log.

3. How to run it
Prerequisites:

Git Bash installed on Windows (or any Bash terminal on Linux/Mac).

AWS CLI installed and configured with your credentials.

jq installed (put jq.exe in your PATH for Windows or install via package manager on Mac/Linux).

Steps:

Copy the script above into a file named:
update_dynamodb_expiration.sh

Open Git Bash (or your preferred Bash terminal).

Make the script executable:

bash
Copiar
Editar
chmod +x update_dynamodb_expiration.sh
Run the script:

bash
Copiar
Editar
./update_dynamodb_expiration.sh
After it completes, check expiration_update_log.csv for a log of all updates and skips.

4. What is jq?
jq is a powerful command-line tool for processing and transforming JSON data.

In this script, jq is used to:

Extract fields (ID, ACCOUNTNUMBER) from DynamoDB scan results.

Check if the expiration field exists.

It acts like sed or awk, but for JSON—making it ideal for working with AWS CLI JSON output.

Official site: stedolan.github.io/jq/

Windows: Download the .exe from the official site and add it to your PATH.

Linux/Mac: Install with your package manager (sudo apt install jq, brew install jq, etc.).

Let me know if you want a downloadable version, troubleshooting tips, or have any other questions!


powershell version

# Configuration
$tableName = "dyno-db"
$logFile = "expiration_update_log.csv"
$expirationDays = 60

# Functions
function Get-Epoch60DaysAhead {
    return [int][double]::Parse((Get-Date).AddDays($expirationDays).ToUniversalTime().Subtract([datetime]'1970-01-01').TotalSeconds)
}

function Write-Log {
    param(
        [string]$id,
        [string]$accountNumber,
        [string]$status
    )
    Add-Content -Path $logFile -Value "$id,$accountNumber,$status"
}

# Start
"ID,ACCOUNTNUMBER,Status" | Set-Content -Path $logFile
Write-Host "Scanning DynamoDB table $tableName ..."

$nextToken = $null
$updatedCount = 0
$page = 1

do {
    if ($null -eq $nextToken) {
        $scanCmd = "aws dynamodb scan --table-name $tableName --output json"
    } else {
        $scanCmd = "aws dynamodb scan --table-name $tableName --output json --starting-token `"$nextToken`""
    }

    # Get scan result and parse JSON
    $scanResult = Invoke-Expression $scanCmd | ConvertFrom-Json

    if ($scanResult.Items -eq $null) {
        Write-Host "No items found in scan page $page."
        break
    }

    foreach ($item in $scanResult.Items) {
        $id = $null
        $accountNumber = $null
        $hasExpiration = $false

        if ($item.PSObject.Properties.Name -contains "ID" -and $item.ID.PSObject.Properties.Name -contains "S") {
            $id = $item.ID.S
        }
        if ($item.PSObject.Properties.Name -contains "ACCOUNTNUMBER" -and $item.ACCOUNTNUMBER.PSObject.Properties.Name -contains "S") {
            $accountNumber = $item.ACCOUNTNUMBER.S
        }
        if ($item.PSObject.Properties.Name -contains "expiration") {
            $hasExpiration = $true
        }

        if ($null -ne $id -and $null -ne $accountNumber -and -not $hasExpiration) {
            $expiration = Get-Epoch60DaysAhead
            $updateCmd = @"
aws dynamodb update-item --table-name $tableName `
--key '{\"ID\": {\"S\": \"$id\"}, \"ACCOUNTNUMBER\": {\"S\": \"$accountNumber\"}}' `
--update-expression "SET expiration = :exp" `
--expression-attribute-values '{":exp": {"N": "$expiration"}}' `
--return-values NONE
"@
            Invoke-Expression $updateCmd | Out-Null
            Write-Log -id $id -accountNumber $accountNumber -status "Updated"
            $updatedCount++
        } else {
            Write-Log -id $id -accountNumber $accountNumber -status "Skipped: Already has expiration or missing keys"
        }
    }

    # Pagination support (AWS CLI v2 uses NextToken, v1 uses LastEvaluatedKey)
    if ($scanResult.PSObject.Properties.Name -contains "NextToken") {
        $nextToken = $scanResult.NextToken
    } elseif ($scanResult.PSObject.Properties.Name -contains "LastEvaluatedKey") {
        $nextToken = $scanResult.LastEvaluatedKey
        if ($nextToken -ne $null) {
            $nextToken = $nextToken | ConvertTo-Json -Compress
        }
    } else {
        $nextToken = $null
    }

    $page++
} while ($null -ne $nextToken -and $nextToken -ne "")

Write-Host "`nUpdate complete. $updatedCount records updated. See $logFile for details."


new command single line

$updateCmd = "aws dynamodb update-item --table-name $tableName " +
             "--key '{\"ID\": {\"S\": \"$id\"}, \"ACCOUNTNUMBER\": {\"S\": \"$accountNumber\"}}' " +
             "--update-expression \"SET expiration = :exp\" " +
             "--expression-attribute-values '{\":exp\": {\"N\": \"$expiration\"}}' " +
             "--return-values NONE"
Invoke-Expression $updateCmd | Out-Null




# =====================[ SETTINGS ]=====================
# Configure these variables as needed:
$tableName = "dyno-db"
$logFile = "expiration_update_log.csv"
$maxJobs = 20

# =====================[ HELPER FUNCTIONS ]=====================
function Wait-ForJobs {
    while ($(Get-Job | Where-Object { $_.State -eq "Running" }).Count -ge $maxJobs) {
        Start-Sleep -Milliseconds 200
    }
}

function Get-Epoch60DaysFromNow {
    return [string]([math]::Floor((Get-Date).AddDays(60).ToUniversalTime() - [datetime]'1970-01-01').TotalSeconds)
}

# =====================[ INITIALIZATION ]=====================
# Clean old log
"ID,ACCOUNTNUMBER,Status" | Out-File -Encoding UTF8 $logFile

# Scan all records in DynamoDB table (pagination)
Write-Host "Scanning DynamoDB table $tableName ..."

$exclusiveStartKey = $null
$updatedCount = 0

do {
    $scanCmd = "aws dynamodb scan --table-name $tableName --output json"
    if ($exclusiveStartKey) {
        $scanCmd += " --starting-token '$exclusiveStartKey'"
    }

    $result = Invoke-Expression $scanCmd | ConvertFrom-Json

    foreach ($item in $result.Items) {
        # Get Keys
        $id = $item.ID.S
        $accountNumber = $item.ACCOUNTNUMBER.S

        # Check for existing expiration
        $hasExpiration = $item.PSObject.Properties.Name -contains "expiration"

        if (-not $hasExpiration -and $id -and $accountNumber) {
            $expiration = Get-Epoch60DaysFromNow

            # --key JSON with proper double quotes
            $keyJson = @{
                ID = @{ S = $id }
                ACCOUNTNUMBER = @{ S = $accountNumber }
            } | ConvertTo-Json -Compress

            # --expression-attribute-values JSON
            $expJson = @{
                ":exp" = @{ N = $expiration }
            } | ConvertTo-Json -Compress

            # Build and execute update-item command
            $updateCmd = @(
                "aws dynamodb update-item",
                "--table-name `"$tableName`"",
                "--key '$keyJson'",
                "--update-expression 'SET expiration = :exp'",
                "--expression-attribute-values '$expJson'",
                "--return-values NONE"
            ) -join " "

            Start-Job -ScriptBlock {
                param($updateCmd, $id, $accountNumber, $logFile)
                $out = Invoke-Expression $updateCmd 2>&1
                if ($LASTEXITCODE -eq 0) {
                    Add-Content $logFile "$id,$accountNumber,Updated"
                } else {
                    Add-Content $logFile "$id,$accountNumber,UpdateError: $out"
                }
            } -ArgumentList $updateCmd, $id, $accountNumber, $logFile

            $updatedCount++
            Wait-ForJobs
        }
        else {
            Add-Content $logFile "$id,$accountNumber,Skipped"
        }
    }

    # Handle pagination
    $exclusiveStartKey = $result.NextToken
} while ($exclusiveStartKey)

# Wait for all jobs to finish
Get-Job | Wait-Job | Out-Null

# Final status
Write-Host "Update process complete. $updatedCount records updated. See $logFile for details."




$keyJson = '{\"ID\":{\"S\":\"' + $id + '\"},\"ACCOUNTNUMBER\":{\"S\":\"' + $accountNumber + '\"}}'
$expJson = '{\":exp\":{\"N\":' + $expiration + '}}'

aws dynamodb update-item --table-name $tableName `
    --key "$keyJson" `
    --update-expression "SET expiration = :exp" `
    --expression-attribute-values "$expJson" `
    --return-values NONE

