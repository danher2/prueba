#!/usr/bin/env bash
set -euo pipefail

EXPIRATION=$(date -u -d "+60 days" +%s)

# Split into 25-line chunks
split -l 25 keys_to_update.txt batch_

# Build one JSON file per chunk
for chunk in batch_*; do
  jsonfile="${chunk}.json"
  {
    echo '{'
    echo '  "test": ['
    while read -r ID ACC; do
      ID=${ID//$'\r'/}
      ACC=${ACC//$'\r'/}
      cat <<EOF
    {
      "PutRequest": {
        "Item": {
          "ID": {"S": "$ID"},
          "ACCOUNTNUMBER": {"S": "$ACC"},
          "expiration": {"N": "$EXPIRATION"}
        }
      }
    },
EOF
    done < "$chunk"
    echo '  ]'
    echo '}'
  } | sed '$s/},/}/' > "$jsonfile"
  echo "Prepared $jsonfile"
done

==========================================================

#!/usr/bin/env bash
set -euo pipefail

# ── Configuration ───────────────────────────────────
EXPIRATION=$(date -u -d "+60 days" +%s)
KEYFILE="keys_to_update.txt"
OUTDIR="batches"
CHUNK_PREFIX="chunk_"

# ── Prepare output directory ────────────────────────
rm -rf "$OUTDIR"
mkdir -p "$OUTDIR"

# ── 1) Split into 25-line chunk files under batches/ ─
split -l 25 "$KEYFILE" "$OUTDIR/${CHUNK_PREFIX}"

# ── 2) For each chunk, emit its JSON batch under batches/ ─
for chunk in "$OUTDIR/${CHUNK_PREFIX}"*; do
  basename=$(basename "$chunk")            # e.g. chunk_aa
  jsonfile="$OUTDIR/${basename}.json"      # e.g. batches/chunk_aa.json

  {
    echo '{'
    echo '  "test": ['
    while read -r ID ACC; do
      # strip any stray CR
      ID=${ID//$'\r'/}
      ACC=${ACC//$'\r'/}
      cat <<EOF
    {
      "PutRequest": {
        "Item": {
          "ID": {"S":"$ID"},
          "ACCOUNTNUMBER": {"S":"$ACC"},
          "expiration": {"N":"$EXPIRATION"}
        }
      }
    },
EOF
    done < "$chunk"
    echo '  ]'
    echo '}'
  } | sed '$s/},/}/' > "$jsonfile"

  echo "Prepared $jsonfile"
done

===================================================================

#!/usr/bin/env bash
set -euo pipefail

# ── Configuration ───────────────────────────────────
EXPIRATION=$(date -u -d "+60 days" +%s)
KEYFILE="keys_to_update.txt"
OUTDIR="batches"
CHUNK_PREFIX="chunk_"

# ── Prepare output directory ────────────────────────
rm -rf "$OUTDIR"
mkdir -p "$OUTDIR"

# ── 1) Split into 25-line chunk files under batches/ ─
split -l 25 "$KEYFILE" "$OUTDIR/${CHUNK_PREFIX}"

# ── 2) For each chunk, emit its JSON batch under batches/ ─
for chunk in "$OUTDIR/${CHUNK_PREFIX}"*; do
  basename=$(basename "$chunk")            # e.g. chunk_aa
  jsonfile="$OUTDIR/${basename}.json"      # e.g. batches/chunk_aa.json

  {
    echo '{'
    echo '  "test": ['

    # load all lines so we can detect the last one
    mapfile -t lines < "$chunk"
    count=${#lines[@]}

    for idx in "${!lines[@]}"; do
      # split ID and ACCOUNTNUMBER
      IFS=$'\t' read -r ID ACC <<< "${lines[idx]}"
      # strip stray CR
      ID=${ID//$'\r'/}
      ACC=${ACC//$'\r'/}

      # output the item
      cat <<EOF
    {
      "PutRequest": {
        "Item": {
          "ID": {"S":"$ID"},
          "ACCOUNTNUMBER": {"S":"$ACC"},
          "expiration": {"N":"$EXPIRATION"}
        }
      }
    }EOF

      # only append a comma if this isn’t the last item
      if (( idx < count - 1 )); then
        echo ","
      else
        echo
      fi
    done

    echo '  ]'
    echo '}'
  } > "$jsonfile"

  echo "Prepared $jsonfile"
done



